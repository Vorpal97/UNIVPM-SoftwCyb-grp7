<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet"href="http://localhost:8080/style">
</head>
<body>
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
  <script>
    window.addEventListener("load", function(){
      var stato = $("input[type='hidden'][id='stato']").val();
      document.getElementById("radio" + stato).checked = true;

      var data = "${evento.data}";

      mydata = data.split("-");
      anno = mydata[0];
      mese = mydata[1];
      giorno = mydata[2];

      if(parseInt(mese) < 10){
        mese = "0" + mese;
      }

      if(parseInt(giorno) < 10){
        giorno = "0" + giorno;
      }

      data = anno + "-" + mese + "-" + giorno;
      $('#eventDate').attr('value', data);

    });

    $(function(){
      var date = new Date();
      date.setDate(date.getDate());

      var month = date.getMonth() + 1;
      var day = date.getDate() +7;
      var year = date.getFullYear();

      if(month < 10)
          month = '0' + month.toString();
      if(day < 10)
          day = '0' + day.toString();


      var maxDate = year + '-' + month + '-' + day;
      $('#eventDate').attr('min', maxDate);
  });


    function annulla(){
      window.location.href='http://localhost:8080/visualizzaeventi';
    }

    function inviaDati(){
      obj = {
        address : document.getElementById("address").value,
        eventName : document.getElementById("eventName").value,
        eventDate : document.getElementById("eventDate").value,
        eventPlace : document.getElementById("eventPlace").value,
        eventNPosti : document.getElementById("eventNPosti").value,
        eventStatus : $("input[type='radio'][name='stato']:checked").val()
      }
      if(obj.eventName == "" || obj.eventDate == "" || obj.eventPlace == "" || obj.eventNPosti == ""){
        document.getElementById("outputBox").innerHTML = "Controlla che tutti i campi siano valorizzati"
      } else {
        if(/^\d+$/.test(obj.eventNPosti)){
          var ticketCounter = $("input[type='text'][id='ticketCounter']").val();
          if(parseInt(obj.eventNPosti) >= parseInt(ticketCounter)){
            document.getElementById("outputBox").innerHTML = ""
            console.log(obj)
            $.ajax({
               type: "POST",
               url: "http://localhost:8080/aggiornaevento",
               data: obj,
               success: function(d) {
                 console.log(d)
                 if(d.stato == "successo"){
                   alert("Evento modificato correttamente!");
                   window.location.href='http://localhost:8080/visualizzaeventi';
                 } else {
                   alert("Si è verificato un errore");
                 }
               }
            });
          } else {
            document.getElementById("outputBox").innerHTML = "Il numero di posti non può essere minore del numero di biglietti venduti"
          }
        } else {
          document.getElementById("outputBox").innerHTML = "Controlla che il numero dei posti sia un valore numerico"
        }
      }
    }
  </script>

<ul>
  <li><a href="http://localhost:8080/">Home</a></li>
  <li><a href="http://localhost:8080/creaevento">Crea Evento</a></li>
  <li><a href="http://localhost:8080/visualizzaeventi">Visualizza Eventi</a></li>
</ul>

<div style="padding:20px;margin-top:30px;background-color:#1abc9c;height:1500px;">
  <div class="center">
    <div class="riquadro riquadroDati">
    <h1>Modifica Evento</h1>

    <form autocomplete="off">
        <input type='hidden' value='${address}' id="address">
        <input type='hidden' value='${evento.stato}' id="stato">
        <label for='fname'>Nome dell'evento:</label><br>
        <input type='text' value='${evento.nome}' id='eventName' required><br>
        <label for='fname'>Data dell'evento:</label><br>
        <input type='date' value='' id='eventDate' required pattern="yyyy-mm-d"><br>
        <label for='fname'>Luogo dell'evento:</label><br>
        <input type='text' value='${evento.luogo}' id='eventPlace' required><br>
        <label for='fname'>Numero posti:</label><br>
        <input type='text' value='${evento.numPosti}' id='eventNPosti' required><br>
        <label for='fname'>Numero di biglietti venduti:</label><br>
        <input type='text' value='${evento.ticketCounter}' id="ticketCounter" readonly>

        <p style ="color:red" id="outputBox"></p>

        <p>Stato:</p>
        <input type='radio' id = "radioinVendita" name='stato' value='inVendita'>
        <label for='inVendita'>In vendita</label><br>
        <input type='radio' id = "radioinCorso" name='stato' value='inCorso'>
        <label for='inCorso'>In corso</label><br>
        <input type='radio' id = "radiosospeso" name='stato' value='sospeso'>
        <label for='sospeso'>Sospeso</label><br>
        <input type='radio' id = "radiosoldout" name='stato' value='soldout'>
        <label for='soldout'>Sold out</label><br>
        <input type='radio' id = "radiocancellato" name='stato' value='cancellato'>
        <label for='cancellato'>Cancellato</label><br>
        <input type='radio' id = "radioterminato" name='stato' value='terminato'>
        <label for='terminato'>Terminato</label><br>
        <!--<input type="submit" value="Modifica Evento">-->
      </form>
      <button class="bottone" onclick="inviaDati()"> Modifica evento </button>
      <button class="bottoneCanc" onclick="annulla()"> Annulla </button>
    </div>
  </div>

</div>

</body>
</html>
